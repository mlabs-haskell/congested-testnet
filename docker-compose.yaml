services:
# ghcr.io/mlabs-haskell/cgnet:latest
  genesis_spo_node:
    image: congested-testnet:latest
    # image: ghcr.io/mlabs-haskell/cgnet:latest
    command: ["sh", "-c", "/scripts/gen_testnet_conf.sh && /scripts/run_genesis_spo.sh"]
    environment:
      - ROOT=/data
      - SHARE=/share
      - TOPOLOGY_GENESIS_SPO_JSON=/scripts/topology_genesis_spo.json
      - PORT=3000
      - BYRON_GENESIS_SPEC_JSON=/scripts/byron.genesis.spec.json
      - CONFIGURATION_YAML=/scripts/configuration.yaml
    ports:
      - "3000:3000"  
      - "12789:12789"  
    expose:
      - "3000"
      - "12789"
    volumes:
      - testnet_data:/data
      - ./scripts:/scripts
    networks:
      my:
        aliases:
          - genesis.local


  post_run_genesis_node:
    image: congested-testnet:latest
    # image: ghcr.io/mlabs-haskell/cgnet:latest
    command: ["sh", "-c", "/scripts/post_run_genesis_node.sh"]
    environment:
      - ROOT=/data
      - SHARE=/share
    volumes:
      - ./scripts:/scripts
      - testnet_data:/data
      - share_config:/share
    restart : "on-failure"
    depends_on:
      - genesis_spo_node


  ogmios:
    # image: ghcr.io/mlabs-haskell/cgnet:latest
    image: congested-testnet:latest
    command: ["sh", "-c", "/scripts/run_ogmios.sh"]
    environment:
      - ROOT=/data
    ports:
      - "1337:1337"  
    expose:
      - "1337"  
    volumes:
      - ./scripts:/scripts
      - testnet_data:/data
      # - relay_node_data:/data
    networks:
      my:
        aliases:
        - ogmios.local
    restart: always


  kupo:
    # image: ghcr.io/mlabs-haskell/cgnet:latest
    image: congested-testnet:latest
    command: ["sh", "-c", "/scripts/run_kupo.sh"]
    environment:
      - ROOT=/data
    ports:
      - "1442:1442"  
    expose:
      - "1442"  
    volumes:
      - ./scripts:/scripts
      - testnet_data:/data
    networks:
      my:
        aliases:
        - kupo.local
    restart: always

  # container contains spammer and faucet
  # spammer:
  #   # image: ghcr.io/mlabs-haskell/cgnet:latest
  #   image: congested-testnet:latest
  #   command: ["sh", "-c", "sleep 8 && spammer"]
  #   environment:
  #     - WALLET_SKEY_PATH=/data/wallet.skey
  #     - SPAMMER_STATE_FILE=/data/state.json
  #     - CARDANO_NODE_METRICS_URL=genesis.local:12789
  #     - SPAMMER_METRIC_PORT=8001
  #     - FAUCET_PORT=8000
  #     - N_WORKERS=2
  #     - OGMIOS_URL=ogmios.local
  #     - KUPO_URL=kupo.local
  #     - MEMPOOL_PAUSE_LIMIT=80000
  #     # off if you don't need spammer or faucet
  #     - SPAMMER_ON=true
  #     - FAUCET_ON=true
  #
  #   ports:
  #     # await tx time metric
  #     - "8001:8001"  
  #     # faucet port 
  #     - "8000:8000"  
  #   volumes:
  #     - ./scripts:/scripts
  #     - testnet_data:/data
  #   networks:
  #     my:
  #       aliases:
  #       - spammer.local
  #   restart: always


  prometheus:
    # image: ghcr.io/mlabs-haskell/cgnet:latest
    image: congested-testnet:latest
    command: ["sh", "-c", "/scripts/run_prometheus.sh"]
    environment:
      - DATA=/data
      - CARDANO_NODE_METRICS_URL=genesis.local:12789
      - SPAMMER_METRICS_URL=spammer.local:8001
    ports:
      - "9090:9090"  
    volumes:
      - ./scripts:/scripts
      - testnet_data:/data
    depends_on:
      - genesis_spo_node
    networks:
      my:
        aliases:
        - prometheus.local
    restart: always




  # relay_node:
  #   image: congested-testnet:latest
  #   command: ["sh", "-c", "/scripts/run_relay_node.sh"]
  #   environment:
  #     - PORT=3000
  #     - ACCESS_URL=genesis_spo_node
  #     - DATA=/data
  #     - CONFIG=/config
  #   expose:
  #     - "3000"
  #     - "12789"
  #   volumes:
  #     - relay_node_data:/data
  #     - share_config:/config
  #     - ./scripts:/scripts
  #   depends_on:
  #     - genesis_spo_node
  #     - wallet
  #   networks:
  #     my:
  #       aliases:
  #         - staking.local
  #   restart : "on-failure"


  # share_config_copy:
  #   image: ghcr.io/intersectmbo/cardano-node:10.1.4
  #   command: ["sh", "-c", "/scripts/copy_share_config.sh"]
  #   environment:
  #     - CONFIGURATION_YAML=/scripts/configuration.yaml
  #     - SHARE=/share
  #     - ROOT=/data
  #   volumes:
  #     - share_config:/share
  #     - testnet_data:/data
  #     - ./scripts:/scripts
  #   restart : "on-failure"
  #
  #
  # share_config:
  #   image: python:3.9-slim
  #   command: ["python", "-m", "http.server", "5000", "--directory", "/share"]
  #   volumes:
  #     - share_config:/share
  #   ports:
  #    - "5000:5000"  
  #   restart : "always"


volumes:
  testnet_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./testnet_data
  share_config:
  relay_node_data:


networks:
  my:
